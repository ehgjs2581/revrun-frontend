<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REVRUN | ê´‘ê³  ì„±ê³¼ ë¦¬í¬íŠ¸</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --cream: #faf8f5; --light-cream: #f5f3ef; --warm-beige: #e8e3db; --medium-brown: #8b7355; --dark-brown: #5d4a3a; --deep-brown: #3a2f23; --accent-green: #22c55e; --accent-green-light: #dcfce7; --accent-pink: #c4a4a4; }
    body { font-family: 'Manrope', -apple-system, sans-serif; background: var(--cream); color: var(--deep-brown); line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 48px 32px 80px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 48px; padding-bottom: 32px; border-bottom: 1px solid var(--warm-beige); }
    .brand { display: flex; align-items: center; gap: 20px; }
    .logo { width: 48px; height: 48px; background: var(--deep-brown); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; color: var(--cream); }
    .brand-info h1 { font-size: 22px; font-weight: 700; color: var(--deep-brown); margin-bottom: 2px; }
    .brand-info span { font-size: 13px; color: var(--medium-brown); }
    .user-area { display: flex; align-items: center; gap: 16px; }
    .user-name { font-size: 14px; font-weight: 600; color: var(--dark-brown); }
    .btn-logout { padding: 10px 24px; border: 1px solid var(--deep-brown); background: transparent; color: var(--deep-brown); font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s ease; border-radius: 8px; }
    .btn-logout:hover { background: var(--deep-brown); color: var(--cream); }
    .page-header { margin-bottom: 40px; }
    .page-title { font-size: 28px; font-weight: 800; color: var(--deep-brown); margin-bottom: 8px; }
    .page-meta { font-size: 14px; color: var(--medium-brown); }
    .card { background: white; border: 1px solid var(--warm-beige); border-radius: 16px; padding: 28px; margin-bottom: 24px; }
    .card-title { font-size: 16px; font-weight: 700; color: var(--deep-brown); margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--warm-beige); }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
    
    /* í†µê³„ ë°•ìŠ¤ - í™”ì‚´í‘œ ì¶”ê°€ */
    .stat-box { background: var(--light-cream); border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
    .stat-label { font-size: 14px; color: var(--dark-brown); font-weight: 500; }
    .stat-sub { font-size: 11px; color: var(--medium-brown); margin-top: 4px; }
    .stat-value-wrap { display: flex; align-items: center; gap: 8px; }
    .stat-value { font-size: 24px; font-weight: 800; color: var(--deep-brown); }
    .stat-value.green { color: var(--accent-green); }
    .stat-arrow { display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: var(--accent-green-light); border-radius: 50%; animation: pulse 2s infinite; }
    .stat-arrow svg { width: 16px; height: 16px; color: var(--accent-green); }
    
    /* í° ìˆ«ì ë°•ìŠ¤ */
    .big-metric-box { background: var(--light-cream); border-radius: 12px; padding: 24px; text-align: center; }
    .big-number-wrap { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px; }
    .big-number { font-size: 48px; font-weight: 800; color: var(--deep-brown); }
    .big-arrow { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: var(--accent-green-light); border-radius: 50%; animation: bounce 1s infinite; }
    .big-arrow svg { width: 20px; height: 20px; color: var(--accent-green); }
    .big-sub { font-size: 14px; color: var(--medium-brown); }
    .progress-simple { height: 8px; background: var(--warm-beige); border-radius: 4px; margin-top: 16px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-green), #4ade80); border-radius: 4px; transition: width 1.5s ease-out; }
    
    .gender-bar { display: flex; height: 40px; border-radius: 8px; overflow: hidden; margin-top: 12px; }
    .gender-male { background: var(--dark-brown); display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 600; }
    .gender-female { background: var(--accent-pink); display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 600; }
    .age-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .age-label { width: 60px; font-size: 13px; color: var(--dark-brown); font-weight: 500; }
    .age-bar-bg { flex: 1; height: 24px; background: var(--warm-beige); border-radius: 6px; overflow: hidden; }
    .age-bar-fill { height: 100%; background: var(--medium-brown); border-radius: 6px; }
    .age-percent { width: 45px; text-align: right; font-size: 14px; font-weight: 700; color: var(--deep-brown); }
    
    /* ë„¤ì´ë²„ ë°•ìŠ¤ */
    .naver-box { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; padding: 24px; display: flex; justify-content: space-between; align-items: center; }
    .naver-label { display: flex; align-items: center; gap: 12px; font-size: 16px; font-weight: 600; color: var(--dark-brown); }
    .naver-icon { width: 32px; height: 32px; background: #03c75a; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 16px; }
    .naver-value-wrap { display: flex; align-items: center; gap: 10px; }
    .naver-value { font-size: 28px; font-weight: 800; color: #16a34a; }
    .naver-arrow { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); animation: bounce 1s infinite; }
    .naver-arrow svg { width: 18px; height: 18px; color: #16a34a; }
    
    .chart-box { background: var(--light-cream); border-radius: 12px; padding: 24px; height: 300px; }
    .insight-list { list-style: none; }
    .insight-item { padding: 16px 0 16px 20px; border-left: 2px solid var(--warm-beige); margin-bottom: 12px; font-size: 15px; color: var(--dark-brown); line-height: 1.6; transition: all 0.3s ease; opacity: 0; animation: fadeInLeft 0.5s forwards; }
    .insight-item:nth-child(1) { animation-delay: 0.1s; }
    .insight-item:nth-child(2) { animation-delay: 0.2s; }
    .insight-item:nth-child(3) { animation-delay: 0.3s; }
    .insight-item:nth-child(4) { animation-delay: 0.4s; }
    .insight-item:hover { border-left-color: var(--deep-brown); padding-left: 24px; }
    .insight-item.highlight { border-left-color: var(--accent-green); }
    .insight-item.action { border-left-color: var(--accent-pink); }
    .insta-link { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 16px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border-radius: 12px; color: white; text-decoration: none; font-weight: 600; font-size: 14px; transition: transform 0.2s, box-shadow 0.2s; }
    .insta-link:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(188, 24, 136, 0.3); }
    
    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    @keyframes fadeInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes countUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .count-animate {
      animation: countUp 0.5s ease-out forwards;
    }
    
    @media (max-width: 768px) { .container { padding: 24px 16px 60px; } .header { flex-direction: column; gap: 20px; text-align: center; } .page-title { font-size: 22px; } .big-number { font-size: 36px; } }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="logo">RV</div>
        <div class="brand-info"><h1>REVRUN</h1><span>ê´‘ê³  ì„±ê³¼ ë¦¬í¬íŠ¸</span></div>
      </div>
      <div class="user-area">
        <span class="user-name" id="userName">-</span>
        <button class="btn-logout" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </header>

    <div class="page-header">
      <h2 class="page-title" id="clientName">ì„±ê³¼ ë¦¬í¬íŠ¸</h2>
      <p class="page-meta" id="period">ìµœê·¼ 30ì¼ ê¸°ì¤€</p>
    </div>

    <div class="card">
      <h3 class="card-title">ğŸ“Š ê´‘ê³  íš¨ê³¼</h3>
      <div class="grid-2" style="margin-bottom: 20px;">
        <div class="stat-box">
          <div>
            <span class="stat-label">ê´‘ê³ ë¥¼ ë³¸ ì‚¬ëŒ</span>
            <div class="stat-sub">ìš°ë¦¬ ê°€ê²Œë¥¼ ì•Œê²Œ ëœ ë¶„ë“¤</div>
          </div>
          <div class="stat-value-wrap">
            <span class="stat-value green" id="reach">-</span>
            <div class="stat-arrow">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
            </div>
          </div>
        </div>
        <div class="big-metric-box">
          <div class="big-number-wrap">
            <span class="big-number" id="impressions">-</span>
            <div class="big-arrow">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
            </div>
          </div>
          <div class="big-sub">ì´ ë…¸ì¶œ íšŸìˆ˜</div>
          <div class="progress-simple"><div class="progress-fill" id="impressionBar" style="width: 0%;"></div></div>
        </div>
      </div>
      <div class="grid-2">
        <div class="stat-box">
          <div>
            <span class="stat-label">ë°˜ì‘í•œ ì‚¬ëŒ</span>
            <div class="stat-sub">ì¢‹ì•„ìš”, ëŒ“ê¸€, í´ë¦­</div>
          </div>
          <div class="stat-value-wrap">
            <span class="stat-value green" id="engagement">-</span>
            <div class="stat-arrow">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
            </div>
          </div>
        </div>
        <div>
          <div class="stat-label" style="margin-bottom: 8px;">ì„±ë³„ ë¹„ìœ¨</div>
          <div class="gender-bar">
            <div class="gender-male" id="maleBar" style="width: 76%;">ë‚¨ì„± 76%</div>
            <div class="gender-female" id="femaleBar" style="width: 24%;">ì—¬ì„± 24%</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">ğŸ‘¥ ì—°ë ¹ëŒ€ë³„ ë°˜ì‘</h3>
      <div id="ageChart">
        <div class="age-row"><span class="age-label">18-24ì„¸</span><div class="age-bar-bg"><div class="age-bar-fill" style="width: 4%;"></div></div><span class="age-percent">4%</span></div>
        <div class="age-row"><span class="age-label">25-34ì„¸</span><div class="age-bar-bg"><div class="age-bar-fill" style="width: 55%;"></div></div><span class="age-percent">55%</span></div>
        <div class="age-row"><span class="age-label">35-44ì„¸</span><div class="age-bar-bg"><div class="age-bar-fill" style="width: 30%;"></div></div><span class="age-percent">30%</span></div>
        <div class="age-row"><span class="age-label">45-54ì„¸</span><div class="age-bar-bg"><div class="age-bar-fill" style="width: 11%;"></div></div><span class="age-percent">11%</span></div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">ğŸª ë„¤ì´ë²„í”Œë ˆì´ìŠ¤ ìœ ì…</h3>
      <div class="naver-box">
        <div class="naver-label">
          <span class="naver-icon">N</span>
          <span>ê´‘ê³  ë³´ê³  ë°©ë¬¸í•œ ê³ ê°</span>
        </div>
        <div class="naver-value-wrap">
          <span class="naver-value" id="naverVisit">-</span>
          <div class="naver-arrow">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">ğŸ“ˆ ì¼ë³„ ì¶”ì´ (ìµœê·¼ 7ì¼)</h3>
      <div class="chart-box"><canvas id="trendChart"></canvas></div>
    </div>

    <div class="card">
      <h3 class="card-title">âœ¨ ì˜ëœ ì </h3>
      <ul class="insight-list" id="highlights"><li class="insight-item highlight">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul>
    </div>

    <div class="card">
      <h3 class="card-title">ğŸ’¡ ë” ì¢‹ì•„ì§€ë ¤ë©´</h3>
      <ul class="insight-list" id="actions"><li class="insight-item action">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul>
    </div>

    <div class="card">
      <h3 class="card-title">ğŸ“± ê´‘ê³  ë¯¸ë¦¬ë³´ê¸°</h3>
      <a href="#" class="insta-link" id="instaLink" target="_blank">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
        ì¸ìŠ¤íƒ€ê·¸ë¨ì—ì„œ ê´‘ê³  ë³´ê¸°
      </a>
    </div>
  </div>

  <script>
    const AD_ACCOUNT_ID = 'act_543464623056642';
    let userData = null;

    async function api(path, opts = {}) {
      const res = await fetch(path, { credentials: "include", headers: { "Content-Type": "application/json" }, ...opts });
      return res.json();
    }

    // ìˆ«ì ì¹´ìš´íŒ… ì• ë‹ˆë©”ì´ì…˜
    function animateCount(element, target, suffix = '') {
      const duration = 1500;
      const start = 0;
      const startTime = performance.now();
      
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = Math.floor(start + (target - start) * easeOut);
        element.textContent = current.toLocaleString('ko-KR') + suffix;
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      element.classList.add('count-animate');
      requestAnimationFrame(update);
    }

    function renderList(id, items, className) {
      const el = document.getElementById(id);
      if (!items || items.length === 0) { 
        el.innerHTML = `<li class="insight-item ${className}">ì•„ì§ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`; 
        return; 
      }
      el.innerHTML = items.map(item => `<li class="insight-item ${className}">${item}</li>`).join('');
    }

    let chart;
    function renderChart(dailyData) {
      const ctx = document.getElementById("trendChart");
      if (chart) chart.destroy();
      
      let labels = [];
      let data = [];
      
      if (dailyData && dailyData.length > 0) {
        labels = dailyData.map(d => {
          const date = new Date(d.date);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        });
        data = dailyData.map(d => d.impressions);
      } else {
        labels = ['ë°ì´í„° ì—†ìŒ'];
        data = [0];
      }
      
      chart = new Chart(ctx, {
        type: "line",
        data: { 
          labels: labels, 
          datasets: [{ 
            label: "ë…¸ì¶œ", 
            data: data, 
            borderColor: "#22c55e", 
            backgroundColor: "rgba(34, 197, 94, 0.1)", 
            fill: true, 
            borderWidth: 3, 
            tension: 0.4, 
            pointRadius: 5,
            pointBackgroundColor: "#22c55e",
            pointBorderColor: "#fff",
            pointBorderWidth: 2
          }] 
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { legend: { display: false } }, 
          scales: { 
            y: { beginAtZero: true, grid: { color: "#e8e3db" }, ticks: { color: "#8b7355", font: { size: 11 } } }, 
            x: { grid: { display: false }, ticks: { color: "#8b7355", font: { size: 11 } } } 
          } 
        }
      });
    }

    async function loadMetaData(campaignId) {
      if (!campaignId) return null;
      try {
        const response = await fetch(`/api/meta/report?action=insights&account_id=${AD_ACCOUNT_ID}`);
        const data = await response.json();
        if (!data.success) return null;
        const campaign = (data.insights || []).find(item => item.campaignId === campaignId);
        if (!campaign) return null;
        return { 
          reach: campaign.reach || 0, 
          impressions: campaign.impressions || 0, 
          clicks: campaign.clicks || 0, 
          conversions: campaign.conversions || 0,
          campaignName: campaign.campaignName || ''
        };
      } catch (error) { return null; }
    }

    async function loadDailyData(campaignId) {
      if (!campaignId) return null;
      try {
        const response = await fetch(`/api/meta/report?action=daily&campaign_id=${campaignId}`);
        const data = await response.json();
        if (!data.success) return null;
        return data.dailyData || [];
      } catch (error) { return null; }
    }

    async function boot() {
      const me = await api("/api/me");
      if (!me?.user) { location.href = "/report/login.html"; return; }
      if (me.user.role === 'admin') { location.href = "/admin/dashboard.html"; return; }

      userData = me.user;
      document.getElementById("userName").textContent = userData.name || userData.username;
      document.getElementById("clientName").textContent = (userData.name || userData.username) + 'ë‹˜ì˜ ë¦¬í¬íŠ¸';
      document.getElementById("period").textContent = 'ìµœê·¼ 30ì¼ ê¸°ì¤€';

      const naverVisitorsExtra = userData.naver_visitors || 0;
      const campaignId = userData.meta_account_id;
      
      // Meta ë°ì´í„° ë¡œë“œ
      const metaData = await loadMetaData(campaignId);
      
      if (metaData) {
        // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ìˆ«ì í‘œì‹œ
        animateCount(document.getElementById("reach"), metaData.reach, 'ëª…');
        animateCount(document.getElementById("impressions"), metaData.impressions, '');
        animateCount(document.getElementById("engagement"), metaData.clicks, 'ëª…');
        
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆë©”ì´ì…˜
        setTimeout(() => {
          const progressPercent = Math.min((metaData.impressions / 30000) * 100, 100);
          document.getElementById("impressionBar").style.width = progressPercent + '%';
        }, 500);
        
        // ë„¤ì´ë²„í”Œë ˆì´ìŠ¤ ìœ ì…
        const landingPageVisits = (metaData.conversions || 0) + naverVisitorsExtra;
        animateCount(document.getElementById("naverVisit"), landingPageVisits, 'ëª…');
      } else {
        document.getElementById("reach").textContent = '-';
        document.getElementById("impressions").textContent = '-';
        document.getElementById("engagement").textContent = '-';
        animateCount(document.getElementById("naverVisit"), naverVisitorsExtra, 'ëª…');
      }

      // ì¸ìŠ¤íƒ€ê·¸ë¨ ê´‘ê³  ë§í¬
      const instaLink = document.getElementById("instaLink");
      if (userData.instagram_url) {
        instaLink.href = userData.instagram_url;
      } else {
        instaLink.href = "https://www.instagram.com";
      }

      // ì¼ë³„ ë°ì´í„° ë¡œë“œ ë° ì°¨íŠ¸ ë Œë”ë§
      const dailyData = await loadDailyData(campaignId);
      renderChart(dailyData);

      // AI ì½”ë©˜íŠ¸ í‘œì‹œ
      let highlights = [];
      let actions = [];
      
      try {
        if (userData.ai_highlights) highlights = JSON.parse(userData.ai_highlights);
        if (userData.ai_actions) actions = JSON.parse(userData.ai_actions);
      } catch (e) {
        console.error('ì½”ë©˜íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', e);
      }

      renderList("highlights", highlights, "highlight");
      renderList("actions", actions, "action");
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => { await api("/api/logout", { method: "POST" }); location.href = "/report/login.html"; });
    boot();
  </script>
</body>
</html>