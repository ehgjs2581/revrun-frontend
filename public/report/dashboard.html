<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REVRUN | 고객 리포트</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body{font-family:system-ui;margin:0;background:#0b0f14;color:#e8eef6}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
    .card{background:#111826;border:1px solid #223046;border-radius:14px;padding:16px;margin-bottom:14px}
    h1{font-size:18px;margin:0}
    h2{font-size:14px;margin:0 0 10px;opacity:.9}
    .muted{opacity:.75;font-size:12px}
    button{padding:10px 14px;border-radius:10px;border:0;background:#4c7dff;color:#fff;font-weight:700;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .kpi{border:1px solid #223046;border-radius:14px;padding:14px;background:#0b1220}
    .kpi .label{font-size:12px;opacity:.75}
    .kpi .value{font-size:22px;font-weight:800;margin-top:6px}
    ul{margin:0;padding-left:18px}
    pre{white-space:pre-wrap;background:#05070b;border:1px solid #223046;border-radius:12px;padding:12px;color:#9bf59b}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #223046;font-size:12px;opacity:.9}
    canvas{background:#0b1220;border:1px solid #223046;border-radius:14px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="top">
      <div>
        <h1 id="title">고객 리포트</h1>
        <div class="row">
          <span class="pill" id="periodPill">-</span>
          <span class="muted" id="metaTxt"></span>
        </div>
      </div>
      <div class="row">
        <span class="muted" id="meTxt"></span>
        <button id="logoutBtn">로그아웃</button>
      </div>
    </div>

    <div class="card">
      <h2>KPI</h2>
      <div class="grid" id="kpiGrid"></div>
    </div>

    <div class="card">
      <h2>성과 차트</h2>
      <canvas id="kpiChart" height="110"></canvas>
    </div>

    <div class="card">
      <h2>하이라이트</h2>
      <ul id="highlights"></ul>
    </div>

    <div class="card">
      <h2>다음 액션</h2>
      <ul id="actions"></ul>
    </div>

    <div class="card">
      <h2>디버그</h2>
      <pre id="debug"></pre>
    </div>

  </div>

  <script>
    async function api(path, opts={}) {
      const res = await fetch(path, {
        credentials:"include",
        headers:{ "Content-Type":"application/json" },
        ...opts
      });
      return res.json();
    }

    function setList(el, arr){
      el.innerHTML = "";
      (arr || []).forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        el.appendChild(li);
      });
      if (!arr || arr.length === 0){
        const li = document.createElement("li");
        li.textContent = "-";
        el.appendChild(li);
      }
    }

    function setKpis(kpis){
      const grid = document.getElementById("kpiGrid");
      grid.innerHTML = "";
      (kpis || []).forEach(k => {
        const div = document.createElement("div");
        div.className = "kpi";
        div.innerHTML = `
          <div class="label">${k.label ?? "-"}</div>
          <div class="value">${k.value ?? "-"}</div>
        `;
        grid.appendChild(div);
      });
      if (!kpis || kpis.length === 0){
        grid.innerHTML = `<div class="muted">표시할 KPI가 없습니다.</div>`;
      }
    }

    let chart;
    function drawChart(kpis){
      const labels = (kpis || []).map(x => x.label);
      const values = (kpis || []).map(x => Number(x.value) || 0);

      const ctx = document.getElementById("kpiChart");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "KPI", data: values }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    async function boot(){
      // 1) 로그인 체크
      const me = await api("/api/me");
      document.getElementById("meTxt").textContent = me?.user ? `${me.user.username} (${me.user.role})` : "로그인 필요";
      if (!me?.user) { location.href = "/report/login.html"; return; }

      // 2) 리포트 가져오기
      const data = await api("/api/report");
      document.getElementById("debug").textContent = JSON.stringify(data, null, 2);

      if (!data.ok){
        document.getElementById("title").textContent = "리포트 로드 실패";
        return;
      }

      const r = data.report || {};
      document.getElementById("title").textContent = `${r.clientName || "고객"} 리포트`;
      document.getElementById("periodPill").textContent = r.period || "-";

      if (r._meta?.created_at){
        document.getElementById("metaTxt").textContent = `최신 업데이트: ${r._meta.created_at}`;
      } else {
        document.getElementById("metaTxt").textContent = "";
      }

      setKpis(r.kpis || []);
      drawChart(r.kpis || []);
      setList(document.getElementById("highlights"), r.highlights || []);
      setList(document.getElementById("actions"), r.actions || []);
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await api("/api/logout", { method:"POST" });
      location.href = "/report/login.html";
    });

    boot();
  </script>
</body>
</html>
